<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cuentas Claras v2.4</title>
    <style>
        :root {
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444;
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
            --border: #e2e8f0; --muted: #64748b; --accent: #f59e0b;
            --input-bg: #f1f5f9;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --border: #334155; --muted: #94a3b8; --input-bg: #334155;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 100px !important; transition: 0.3s; }
        
        .container { max-width: 100%; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* --- SISTEMA DE PESTAÃ‘AS --- */
        .tab-content { display: none; flex-direction: column; gap: 20px; width: 100%; }
        .tab-content.active { display: flex; }

        /* --- BARRA DE NAVEGACIÃ“N --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: var(--card); display: flex; justify-content: space-around;
            align-items: center; border-top: 1px solid var(--border); z-index: 2000;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--muted); font-size: 0.7rem; cursor: pointer; flex: 1; opacity: 0.6; }
        .nav-item.active { color: var(--primary); font-weight: bold; opacity: 1; }
        .nav-item span { font-size: 1.3rem; margin-bottom: 2px; }

        /* --- BOTÃ“N FLOTANTE --- */
        .fab {
            position: fixed; bottom: 85px; left: 20px; width: 50px; height: 50px;
            background: var(--primary); color: white; border-radius: 50%;
            border: none; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1999;
        }

        /* --- TUS ESTILOS ORIGINALES REUTILIZADOS --- */
        header { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .quick-entry-bar { background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white; padding: 15px; border-radius: 16px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .quick-entry-bar input { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; padding: 8px; }
        .quick-entry-bar input::placeholder { color: rgba(255,255,255,0.7); }
        
        .section-card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; background: var(--input-bg); padding: 12px; border-radius: 12px; margin-bottom: 15px; }
        
        .ed-panel { background: #1e293b; color: white; padding: 20px; border-radius: 16px; border: 1px solid #334155; }
        .ed-bar-bg { background: #334155; height: 12px; border-radius: 6px; margin: 10px 0; overflow: hidden; }
        .ed-bar-fill { background: linear-gradient(90deg, #10b981, #34d399); height: 100%; width: 0%; transition: 0.5s; }
        .ed-grid { display: flex; justify-content: space-between; text-align: center; }
        .ed-stat label { display: block; font-size: 0.65rem; color: #94a3b8; }

        table { width: 100%; border-collapse: collapse; display: block; overflow-x: auto; }
        th { color: var(--muted); font-size: 0.7rem; padding: 10px; border-bottom: 2px solid var(--border); text-align: left; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }

        .privacy-active .blur-text { filter: blur(6px); }
        .cal-day { font-size: 0.75rem; border: 1px solid var(--border); aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; background: var(--input-bg); }
        .has-event { border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .is-today { background: var(--accent); color: white; }

        input, select { height: 40px; border-radius: 8px; border: 1px solid var(--border); padding: 0 10px; background: var(--card); color: var(--text); }
        button { padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border); font-weight: 600; cursor: pointer; }
        button.primary { background: var(--primary); color: white; border: none; }
        button.success { background: var(--success); color: white; border: none; }
        button.danger { background: var(--danger); color: white; border: none; }

        #importModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; }
    </style>
</head>
<body id="mainBody">

<div class="container">
    <header>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 style="margin:0; color:var(--primary); font-size: 1.4rem;">Cuentas Claras <span style="font-size:0.7rem; color:var(--muted)">v2.4</span></h1>
            <button onclick="toggleTheme()">ğŸŒ“</button>
        </div>
        <div style="display:flex; align-items:center; justify-content:center; gap:10px">
            <button onclick="changeMonth(-1)">â—€</button>
            <h2 id="currentMonthLabel" style="margin:0; font-size: 1.1rem; text-transform: capitalize;"></h2>
            <button onclick="changeMonth(1)">â–¶</button>
        </div>
        <div style="display:flex; gap:8px; overflow-x: auto; padding-bottom: 5px;">
            <label class="switch"><input type="checkbox" id="edToggle" onchange="toggleEDMode()"><span class="slider"></span></label>
            <span style="font-size:0.8rem">EveryDollar</span>
            <button id="privacyBtn" onclick="togglePrivacy()" style="font-size:0.7rem">ğŸ‘ï¸ Privacidad</button>
            <button onclick="openImportModal()" style="font-size:0.7rem">ğŸ“‹ Clonar</button>
            <button onclick="exportData()" style="font-size:0.7rem">ğŸ’¾ Backup</button>
        </div>
    </header>

    <div id="tab-gastos" class="tab-content active">
        <div class="quick-entry-bar" id="qeBarAnchor">
            <strong>âš¡ Quick:</strong>
            <input type="text" id="qeDesc" placeholder="Â¿QuÃ© compraste?" style="flex:2">
            <input type="number" id="qeAmount" placeholder="$" style="flex:1">
            <button class="success" onclick="addQuickExpense()" style="background:white; color:var(--success)">+</button>
        </div>

        <section class="section-card" style="border-left: 4px solid var(--accent)">
            <h3 style="margin:0 0 10px 0">ğŸ›’ Gastos Diarios</h3>
            <table><tbody id="dailyTableBody"></tbody></table>
        </section>

        <section class="section-card">
            <h3>ğŸ’° Ingresos</h3>
            <div class="grid-inputs">
                <input type="date" id="incDate">
                <input type="text" id="incDesc" placeholder="Fuente">
                <input type="number" id="incAmount" placeholder="Monto">
                <button class="success" onclick="addIncome()">+</button>
            </div>
            <table><tbody id="incTableBody"></tbody></table>
        </section>

        <section class="section-card">
            <h3>ğŸ“º Suscripciones</h3>
            <div class="grid-inputs">
                <input type="text" id="subName" placeholder="Servicio">
                <input type="number" id="subAmount" placeholder="Monto">
                <input type="number" id="subDay" placeholder="DÃ­a">
                <button class="primary" onclick="addSubscription()">+</button>
            </div>
            <table><tbody id="subTableBody"></tbody></table>
        </section>

        <section class="section-card">
            <h3>ğŸ’¸ Gastos Fijos</h3>
            <div class="grid-inputs">
                <input type="date" id="expDate">
                <input type="text" id="expDesc" placeholder="Concepto">
                <select id="expCat">
                    <option value="Vivienda">ğŸ  Vivienda</option>
                    <option value="Servicios">âš¡ Servicios</option>
                    <option value="Comida">ğŸ” Comida</option>
                    <option value="Ocio">ğŸ¬ Ocio</option>
                </select>
                <input type="number" id="expAmount" placeholder="Monto">
                <button class="danger" onclick="addExpense()">+</button>
            </div>
            <table><tbody id="expTableBody"></tbody></table>
        </section>
    </div>

    <div id="tab-plan" class="tab-content">
        <section class="section-card">
            <h4 style="margin:0 0 15px 0; text-align:center">ğŸ“… Calendario</h4>
            <div id="calendarGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px;"></div>
        </section>

        <section class="section-card">
            <h3>ğŸ’³ Tarjetas</h3>
            <div class="grid-inputs">
                <input type="text" id="ccName" placeholder="Tarjeta">
                <input type="number" id="ccPlan" placeholder="Pago Mes">
                <input type="date" id="ccVence" placeholder="Vence">
                <input type="number" id="ccBalance" placeholder="Saldo Total">
                <button class="primary" onclick="addCard()" style="grid-column: 1/-1">+ Agregar</button>
            </div>
            <table><tbody id="ccTableBody"></tbody></table>
        </section>

        <section class="section-card">
            <h4>â„ï¸ Bola de Nieve</h4>
            <div id="snowballList"></div>
        </section>
    </div>

    <div id="tab-resumen" class="tab-content">
        <div id="edPanel" class="ed-panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold;">Presupuesto</span>
                <span id="edStatus" class="blur-text" style="background:var(--success); padding:3px 10px; border-radius:15px; font-size:0.8rem;"></span>
            </div>
            <div class="ed-bar-bg"><div id="edBar" class="ed-bar-fill"></div></div>
            <div class="ed-grid">
                <div class="ed-stat"><label>Ingresos</label><span id="edInc" class="blur-text"></span></div>
                <div class="ed-stat"><label>Gastos</label><span id="edExp" class="blur-text"></span></div>
                <div class="ed-stat"><label>Restante</label><span id="edNet" class="blur-text"></span></div>
            </div>
        </div>

        <section class="section-card">
            <h4>ğŸ“Š DistribuciÃ³n</h4>
            <div id="categoryChart"></div>
        </section>
    </div>
</div>

<button class="fab" onclick="switchTab(null, 'gastos'); document.getElementById('qeDesc').focus();">âš¡</button>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab(event, 'gastos')"><span>ğŸ </span>Gastos</div>
    <div class="nav-item" onclick="switchTab(event, 'plan')"><span>ğŸ“…</span>Pagos</div>
    <div class="nav-item" onclick="switchTab(event, 'resumen')"><span>ğŸ“Š</span>Resumen</div>
</nav>

<div id="importModal">
    <div class="modal-content">
        <h3>Clonar Mes</h3>
        <label><input type="checkbox" id="impInc" checked> Ingresos</label><br>
        <label><input type="checkbox" id="impSub" checked> Suscripciones</label><br>
        <label><input type="checkbox" id="impExp" checked> Gastos Fijos</label><br>
        <label><input type="checkbox" id="impCC" checked> Tarjetas</label><br>
        <div style="display:flex; gap:10px; margin-top:20px">
            <button class="primary" onclick="processImport()" style="flex:1">Si</button>
            <button onclick="closeImportModal()" style="flex:1">No</button>
        </div>
    </div>
</div>

<script>
    let currentDate = new Date();
    let appData = JSON.parse(localStorage.getItem('cuentasClarasData')) || {};
    let edMode = localStorage.getItem('edMode') === 'true';
    let privacyMode = false;

    function getMonthKey(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; }
    function saveData() { localStorage.setItem('cuentasClarasData', JSON.stringify(appData)); render(); }

    function switchTab(event, tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
        else document.querySelector(`.nav-item[onclick*="${tabId}"]`).classList.add('active');
        window.scrollTo(0,0);
    }

    function toggleEDMode() { edMode = document.getElementById('edToggle').checked; localStorage.setItem('edMode', edMode); render(); }
    function togglePrivacy() { privacyMode = !privacyMode; document.getElementById('mainBody').classList.toggle('privacy-active', privacyMode); }

    function render() {
        const key = getMonthKey(currentDate);
        if (!appData[key]) appData[key] = { income:[], expenses:[], cards:[], daily:[], subs:[] };
        const d = appData[key];

        document.getElementById('edToggle').checked = edMode;
        document.getElementById('edPanel').style.display = edMode ? 'block' : 'none';
        document.getElementById('currentMonthLabel').innerText = currentDate.toLocaleString('es', {month:'long', year:'numeric'});

        // Totales
        let tInc = d.income.reduce((s,x)=>s+parseFloat(x.amount||0),0);
        let tSub = (d.subs||[]).reduce((s,x)=>s+parseFloat(x.amount||0),0);
        let tExp = d.expenses.reduce((s,x)=>s+parseFloat(x.amount||0),0) + tSub;
        let tDaily = (d.daily||[]).reduce((s,x)=>s+parseFloat(x.amount||0),0);
        let tCC = d.cards.reduce((s,x)=>s+parseFloat(x.plan||0),0);

        // Render Tables
        document.getElementById('dailyTableBody').innerHTML = (d.daily||[]).map((x,i)=>`<tr><td>${x.date.split('-')[2]}</td><td>${x.desc}</td><td class="blur-text"><strong>$${x.amount}</strong></td><td><button onclick="deleteItem('daily',${i})">ğŸ—‘</button></td></tr>`).join('');
        document.getElementById('incTableBody').innerHTML = d.income.map((x,i)=>`<tr><td>${x.desc}</td><td class="blur-text">$${x.amount}</td><td><button onclick="deleteItem('income',${i})">ğŸ—‘</button></td></tr>`).join('');
        document.getElementById('subTableBody').innerHTML = (d.subs||[]).map((x,i)=>`<tr><td><input type="checkbox" ${x.paid?'checked':''} onchange="togglePaid('subs',${i})"></td><td>${x.name}</td><td class="blur-text">$${x.amount}</td><td><button onclick="deleteItem('subs',${i})">ğŸ—‘</button></td></tr>`).join('');
        document.getElementById('expTableBody').innerHTML = d.expenses.map((x,i)=>`<tr><td><input type="checkbox" ${x.paid?'checked':''} onchange="togglePaid('expenses',${i})"></td><td>${x.desc}</td><td class="blur-text">$${x.amount}</td><td><button onclick="deleteItem('expenses',${i})">ğŸ—‘</button></td></tr>`).join('');
        document.getElementById('ccTableBody').innerHTML = d.cards.map((x,i)=>`<tr><td><input type="checkbox" ${x.paid?'checked':''} onchange="togglePaid('cards',${i})"></td><td>${x.name}</td><td class="blur-text">$${x.plan}</td><td><button onclick="deleteItem('cards',${i})">ğŸ—‘</button></td></tr>`).join('');

        // EveryDollar Logic
        const totalGastado = tExp + tDaily + tCC;
        document.getElementById('edInc').innerText = `$${tInc}`;
        document.getElementById('edExp').innerText = `$${totalGastado}`;
        document.getElementById('edNet').innerText = `$${tInc - totalGastado}`;
        let pct = tInc > 0 ? (totalGastado / tInc) * 100 : 0;
        document.getElementById('edBar').style.width = Math.min(pct, 100) + '%';
        document.getElementById('edStatus').innerText = (tInc - totalGastado) === 0 ? "Perfecto" : `$${(tInc-totalGastado).toFixed(0)} libre`;

        renderCalendar(d);
        updateSnowball(d.cards);
        updateChart(d);
    }

    function renderCalendar(data) {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = ['D','L','M','M','J','V','S'].map(d=>`<div style="font-size:0.5rem; text-align:center">${d}</div>`).join('');
        const year = currentDate.getFullYear(); const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
        for (let d = 1; d <= daysInMonth; d++) {
            const isT = (d === new Date().getDate() && month === new Date().getMonth()) ? 'is-today' : '';
            grid.innerHTML += `<div class="cal-day ${isT}">${d}</div>`;
        }
    }

    function addQuickExpense() {
        const desc = document.getElementById('qeDesc').value;
        const amount = document.getElementById('qeAmount').value;
        if(desc && amount) {
            appData[getMonthKey(currentDate)].daily.push({ date: new Date().toISOString().split('T')[0], desc, amount: parseFloat(amount), cat:'Otros' });
            document.getElementById('qeDesc').value = ''; document.getElementById('qeAmount').value = '';
            saveData();
        }
    }

    // Funciones de ayuda (Income, Subs, etc)
    function addIncome() { appData[getMonthKey(currentDate)].income.push({ desc: document.getElementById('incDesc').value, amount: document.getElementById('incAmount').value }); saveData(); }
    function addSubscription() { appData[getMonthKey(currentDate)].subs.push({ name: document.getElementById('subName').value, amount: document.getElementById('subAmount').value, day: document.getElementById('subDay').value, paid: false }); saveData(); }
    function addExpense() { appData[getMonthKey(currentDate)].expenses.push({ desc: document.getElementById('expDesc').value, cat: document.getElementById('expCat').value, amount: document.getElementById('expAmount').value, paid: false }); saveData(); }
    function addCard() { appData[getMonthKey(currentDate)].cards.push({ name: document.getElementById('ccName').value, plan: document.getElementById('ccPlan').value, balance: document.getElementById('ccBalance').value, vence: document.getElementById('ccVence').value, paid: false }); saveData(); }
    
    function togglePaid(type, i) { appData[getMonthKey(currentDate)][type][i].paid = !appData[getMonthKey(currentDate)][type][i].paid; saveData(); }
    function deleteItem(type, i) { appData[getMonthKey(currentDate)][type].splice(i, 1); saveData(); }
    function changeMonth(o) { currentDate.setMonth(currentDate.getMonth()+o); render(); }
    function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function openImportModal() { document.getElementById('importModal').style.display = 'flex'; }
    function closeImportModal() { document.getElementById('importModal').style.display = 'none'; }
    
    function updateSnowball(cards) {
        let s = [...cards].filter(c=>c.balance>0).sort((a,b)=>a.balance-b.balance);
        document.getElementById('snowballList').innerHTML = s.map(c=>`<div style="font-size:0.8rem">${c.name}: $${c.balance}</div>`).join('') || 'Sin deudas';
    }

    function updateChart(d) {
        const cats = {};
        [...d.expenses, ...d.daily].forEach(e => cats[e.cat||'Otros'] = (cats[e.cat||'Otros']||0) + parseFloat(e.amount));
        document.getElementById('categoryChart').innerHTML = Object.entries(cats).map(([n,v])=>`<div style="font-size:0.8rem">${n}: $${v}</div>`).join('');
    }

    function exportData() { alert("Backup guardado en consola (puedes implementar File API)"); console.log(JSON.stringify(appData)); }

    window.onload = render;
</script>
</body>
</html>
